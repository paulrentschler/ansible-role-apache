#
# {{ ansible_managed }}
#
#
# This is the main Apache server configuration file.  It contains the
# configuration directives that give the server its instructions.
# See http://httpd.apache.org/docs/2.4 for detailed information.
#

### Section 1: Global Environment
#
# The directives in this section affect the overall operation of Apache
#

#
# Don't give away too much information about all the subcomponents
# we are running.
#
ServerTokens Prod
ServerSignature Off
Header always unset "X-Powered-By"
Header always unset "X-Runtime"
TraceEnable Off

#
# ServerRoot: The top of the directory tree under which the server's
# configuration, error, and log files are kept.
#
# Do NOT add a slash at the end of the directory path.
#
ServerRoot "/etc/{{ apache_daemon }}"

#
# The accept serialization lock file MUST BE STORED ON A LOCAL DISK.
#
#Mutex file:/var/lock/apache2 default

{% if ansible_os_family == 'Debian' %}
#
# The directory where shm and other runtime files will be stored.
#
DefaultRuntimeDir ${APACHE_RUN_DIR}

#
# PidFile: The file in which the server should record its process
# identification number when it starts.  Note the PIDFILE variable in
# /etc/sysconfig/httpd must be set appropriately if this location is
# changed.
#
PidFile ${APACHE_PID_FILE}

{% endif %}
#
# Timeout: The number of seconds before receives and sends time out.
#
TimeOut 300

#
# KeepAlive: Whether or not to allow persistent connections (more than
# one request per connection). Set to "Off" to deactivate.
#
KeepAlive On

#
# MaxKeepAliveRequests: The maximum number of requests to allow
# during a persistent connection. Set to 0 to allow an unlimited amount.
# We recommend you leave this number high, for maximum performance.
#
MaxKeepAliveRequests 100

#
# KeepAliveTimeout: Number of seconds to wait for the next request from the
# same client on the same connection.
#
KeepAliveTimeout 5


##
## Server-Pool Size Regulation (MPM specific)
##

# prefork MPM
# StartServers: number of server processes to start
# MinSpareServers: minimum number of server processes which are kept spare
# MaxSpareServers: maximum number of server processes which are kept spare
# ServerLimit: maximum value for MaxClients for the lifetime of the server
# MaxClients: maximum number of server processes allowed to start
# MaxRequestsPerChild: maximum number of requests a server process serves
#
<IfModule prefork.c>
    StartServers            8
    MinSpareServers         5
    MaxSpareServers        20
    ServerLimit           256
    MaxClients            256
    MaxRequestsPerChild  4000
</IfModule>

# worker MPM
# StartServers: initial number of server processes to start
# MaxClients: maximum number of simultaneous client connections
# MinSpareThreads: minimum number of worker threads which are kept spare
# MaxSpareThreads: maximum number of worker threads which are kept spare
# ThreadsPerChild: constant number of worker threads in each server process
# MaxRequestsPerChild: maximum number of requests a server process serves
#
<IfModule worker.c>
    StartServers           4
    MaxClients           300
    MinSpareThreads       25
    MaxSpareThreads       75
    ThreadsPerChild       25
    MaxRequestsPerChild    0
</IfModule>


#
# Dynamic Shared Object (DSO) Support
#
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf


#
# Listen: Allows you to bind Apache to specific IP addresses and/or ports
#
Listen 80


#
# ExtendedStatus controls whether Apache will generate "full" status
# information (ExtendedStatus On) or just basic information (ExtendedStatus
# Off) when the "server-status" handler is called. The default is Off.
#
#ExtendedStatus On

#
# If you wish httpd to run as a different user or group, you must run
# httpd as root initially and it will switch.
#
User  {{ apache_user }}
Group {{ apache_group }}



### Section 2: 'Main' server configuration
#
# The directives in this section set up the values used by the 'main'
# server, which responds to any requests that aren't handled by a
# <VirtualHost> definition.  These values also provide defaults for
# any <VirtualHost> containers you may define later in the file.
#

#
# ServerAdmin: Your address, where problems with the server should be
# e-mailed.  This address appears on some server-generated pages, such
# as error documents.  e.g. admin@your-domain.com
#
ServerAdmin {{ apache_admin_email }}

#
# ServerName gives the name and port that the server uses to identify itself.
# Use 127.0.0.1 to avoid the "Could not reliably determine the server's fully
#  qualified domain name, using 127.0.0.1 for ServerName" error on startup.
#
ServerName 127.0.0.1

#
# UseCanonicalName: Determines how Apache constructs self-referencing
# URLs and the SERVER_NAME and SERVER_PORT variables.
#
UseCanonicalName Off

#
# Each directory to which Apache has access can be configured with respect
# to which services and features are allowed and/or disabled in that
# directory (and its subdirectories).
#
# Enable: symbolic links to be followed
# Disable: directory listings, Server Side Includes (SSI) and CGI file executions
#
<Directory />
    Options -Indexes +FollowSymLinks -Includes -ExecCGI
    AllowOverride none
    Require all denied
</Directory>

#
# Note that from this point forward you must specifically allow
# particular features to be enabled - so if something's not working as
# you might expect, make sure that you have specifically enabled it
# below.
#


#
# DirectoryIndex: sets the file that Apache will serve if a directory
# is requested.
#
# The index.html.var file (a type-map) is used to deliver content-
# negotiated documents.  The MultiViews Option can be used for the
# same purpose, but it is much slower.
#
DirectoryIndex index.html index.html.var

#
# AccessFileName: The name of the file to look for in each directory
# for additional configuration directives.  See also the AllowOverride
# directive.
#
AccessFileName .htaccess

#
# The following lines prevent .htaccess and .htpasswd files from being
# viewed by Web clients.
#
<Files ~ "^\.ht">
    Require all denied
</Files>

#
# Forbid access to version control directories
#
<DirectoryMatch "/\.[svn|hg|git]">
    Require all denied
</DirectoryMatch>

<IfModule mime_module>
    #
    # TypesConfig describes where the mime.types file (or equivalent) is
    # to be found.
    #
    TypesConfig /etc/mime.types

    #
    # DefaultType is the default MIME type the server will use for a document
    # if it cannot otherwise determine one, such as from filename extensions.
    #
    # "text/plain" is good if the server is mostly text or HTML documents.
    # "application/octet-stream" is good if the server is mostly binary content.
    # "None" allows the client's browser to guess an appropriate action.
    #
    DefaultType None

    #
    # MIME-types for compressed files
    #
    AddType application/x-compress .Z
    AddType application/x-gzip     .gz .tgz

    #
    # MIME-types for downloading Certificates and CRLs
    #
    AddType application/x-x509-ca-cert .crt
    AddType application/x-pkcs7-crl    .crl

    #
    # Parse .shtml files for server-side includes (SSI)
    # "Includes" needs to be added to the "Options" directive
    #
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
</IfModule>

#
# Specify a default charset for all content served; this enables
# interpretation of all content as UTF-8 by default.  To use the
# default browser choice (ISO-8859-1), or to allow the META tags
# in HTML content to override this choice, comment out this
# directive:
#
AddDefaultCharset UTF-8

<IfModule mod_mime_magic.c>
    #
    # The mod_mime_magic module allows the server to use various hints from the
    # contents of the file itself to determine its type.  The MIMEMagicFile
    # directive tells the module where the hint definitions are located.
    #
    MIMEMagicFile {{ apache_magicfile }}
</IfModule>

#
# HostnameLookups: Log the names of clients or just their IP addresses
#
HostnameLookups Off

#
# EnableMMAP: Control whether memory-mapping is used to deliver
# files (assuming that the underlying OS supports it).
# The default is on; turn this off if you serve from NFS-mounted
# filesystems.  On some systems, turning it off (regardless of
# filesystem) can improve performance; for details, please see
# http://httpd.apache.org/docs/2.4/mod/core.html#enablemmap
#
#EnableMMAP off

#
# EnableSendfile: Control whether the sendfile kernel support is
# used to deliver files (assuming that the OS supports it).
# The default is on; turn this off if you serve from NFS-mounted
# filesystems.  Please see
# http://httpd.apache.org/docs/2.4/mod/core.html#enablesendfile
#
#EnableSendfile off


#
# Location of the error log file
#
ErrorLog {{ apache_log_path }}/default/error.log

#
# LogLevel: Control the number of messages logged to the error_log
# Possible values: debug, info, notice, warn, error, crit, alert, emerg
#
LogLevel {{ apache_loglevel|default('warn') }}

#
# Define some format nicknames for use with the CustomLog directive
#
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

#
# Single access log file with access, agent, and referer information
#
CustomLog {{ apache_log_path }}/default/access.log combined


#
# WebDAV module configuration section.
#
<IfModule mod_dav_fs.c>
    # Location of the WebDAV lock database.
    DAVLockDB /var/lib/dav/lockdb
</IfModule>

#
# Modify normal HTTP response behavior to handle known
#  problems with browser implementations
#
BrowserMatch "Mozilla/2" nokeepalive
BrowserMatch "MSIE 4\.0b2;" nokeepalive downgrade-1.0 force-response-1.0
BrowserMatch "RealPlayer 4\.0" force-response-1.0
BrowserMatch "Java/1\.0" force-response-1.0
BrowserMatch "JDK/1\.0" force-response-1.0

#
# Disables redirects on non-GET requests for a directory that does not
#  include the trailing slash.
# This fixes a problem with Microsoft WebFolders which does not
#  appropriately handle redirects for folders with DAV methods.
# Same deal with Apple's DAV filesystem and Gnome VFS support for DAV.
#
BrowserMatch "Microsoft Data Access Internet Publishing Provider" redirect-carefully
BrowserMatch "MS FrontPage" redirect-carefully
BrowserMatch "^WebDrive" redirect-carefully
BrowserMatch "^WebDAVFS/1.[0123]" redirect-carefully
BrowserMatch "^gnome-vfs/1.0" redirect-carefully
BrowserMatch "^XML Spy" redirect-carefully
BrowserMatch "^Dreamweaver-WebDAV-SCM1" redirect-carefully


#
# Disable the FileETag header from disclosing inode info
#
Header unset ETag
FileETag MTime Size


#
# Prevent clickjacking attacks
#
# Only enable if the site pages does not need rendered in a <frame>,
# <iframe> or <object>.
#
Header always append X-Frame-Options SAMEORIGIN


#
# Include additional configuration files
#
IncludeOptional conf-enabled/*.conf



### Section 3: Virtual Hosts
#
# Virtual hosting allows one server to host websites for multiple
#  domains/hostnames. Each virtual host is defined in it's own file found
#  in the sites-available directory. Enabled virtual hosts have their
#  configuration file symlinked from the sites-available directory to the
#  sites-enabled directory.
# Most configurations use only name-based virtual hosts so the server
#  doesn't need to worry about IP addresses. Hosting multiple SSL-enabled
#  sites requires the use of IP-based virtual hosting instead of name-based.
# See <URL:http://httpd.apache.org/docs/2.4/vhosts/> for detailed information.

#
# Include enabled virtual host config files from the sites-enbled directory
#
IncludeOptional sites-enabled/*.conf

